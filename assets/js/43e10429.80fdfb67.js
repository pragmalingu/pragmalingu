(self.webpackChunkpragmalingu_github_io=self.webpackChunkpragmalingu_github_io||[]).push([[226],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return c},kt:function(){return p}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},h=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),h=u(n),p=a,m=h["".concat(s,".").concat(p)]||h[p]||d[p]||i;return n?r.createElement(m,o(o({ref:t},c),{},{components:n})):r.createElement(m,o({ref:t},c))}));function p(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var u=2;u<i;u++)o[u]=n[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}h.displayName="MDXCreateElement"},938:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return o},contentTitle:function(){return l},metadata:function(){return s},toc:function(){return u},default:function(){return d}});var r=n(2122),a=n(9756),i=(n(7294),n(3905)),o={id:"ranking-api",title:"How to Use the Elasticsearch Ranking Evaluation API",sidebar_label:"Ranking Evaluation API",custom_edit_url:null},l=void 0,s={unversionedId:"guides/ranking-api",id:"guides/ranking-api",isDocsHomePage:!1,title:"How to Use the Elasticsearch Ranking Evaluation API",description:"1. Introduction",source:"@site/docs/guides/ranking-api.mdx",sourceDirName:"guides",slug:"/guides/ranking-api",permalink:"/docs/guides/ranking-api",editUrl:null,version:"current",frontMatter:{id:"ranking-api",title:"How to Use the Elasticsearch Ranking Evaluation API",sidebar_label:"Ranking Evaluation API",custom_edit_url:null},sidebar:"guides",previous:{title:"Working with Notebooks",permalink:"/docs/guides/notebooks"}},u=[{value:"1. Introduction",id:"1-introduction",children:[]},{value:"2. Query Metrics",id:"2-query-metrics",children:[]},{value:"3. Rating Metric",id:"3-rating-metric",children:[]},{value:"4. Evaluation Metrics",id:"4-evaluation-metrics",children:[]}],c={toc:u};function d(e){var t=e.components,n=(0,a.Z)(e,["components"]);return(0,i.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h3",{id:"1-introduction"},"1. Introduction"),(0,i.kt)("p",null,"To evaluate our experiments we used the built-in ",(0,i.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-rank-eval.html"},"Ranking Evaluation API")," by Elasticsearch.\nIn order to adjust the Ranking Evaluation API to your needs this guide will give you some short explanations of the operators and metrics we used during our experiments."),(0,i.kt)("p",null,"Before we start, the Ranking Evaluation API requires three inputs in order to provide accurate results:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Document(s) to be evaluated"),(0,i.kt)("li",{parentName:"ul"},"A few typical queries for said document(s)"),(0,i.kt)("li",{parentName:"ul"},"Relevance assessments that represent document ratings regarding the queries")),(0,i.kt)("p",null,"First, we need to save the desired document(s) to an Elasticsearch index. Detailed instructions on how to do this can be found in our ",(0,i.kt)("a",{parentName:"p",href:"/docs/guides/elastic-setup"},"Elasticsearch Setup Guide"),"."),(0,i.kt)("p",null,"Next, you will need to ensure that the search queries are properly formatted for use with the Ranking Evaluation API. Please see our ",(0,i.kt)("a",{parentName:"p",href:"/docs/guides/how-to-parse"},"Parsing Guide")," for detailed instructions on formatting raw data"),(0,i.kt)("p",null,"After parsing the queries, they should have the following format:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n    \n  "requests": [\n    {\n      "id": "Query_1",                                  \n      "request": {                                              \n          "query": { "match": { "text": "\\nwhat are the structural and aeroelastic problems associated with flight\\nof high speed aircraft .\\n" } }\n      },\n      "ratings": [                                              \n        { "_index": "cranfield-corpus", "_id": "184", "rating": 1 },\n        { "_index": "cranfield-corpus", "_id": "29", "rating": 1 },\n        { "_index": "cranfield-corpus", "_id": "31", "rating": 1 }\n      ]\n    },\n    {\n      "id": "Query_2",\n      "request": {\n        "query": { "match": { "text": "\\nwhat problems of heat conduction in composite slabs have been solved so\\nfar .\\n" } }\n      },\n      "ratings": [\n        { "_index": "cranfield-corpus", "_id": "12", "rating": 1 }\n      ]\n    }\n  ]\n  "metric": {\n    "precision": {\n      "k": 20,\n      "relevant_rating_threshold": 1,\n      "ignore_unlabeled": false\n    }\n  }\n}\n')),(0,i.kt)("p",null,"According to the  ",(0,i.kt)("a",{parentName:"p",href:"https://elasticsearch-py.readthedocs.io/en/master/api.html"},"Python API Documentation website")," for the Ranking Evaluation API this is called the \u201cbody\u201d so from here we will refer to this as the \u201cevaluation body\u201d.\nAfter saving the body as a variable called ",(0,i.kt)("inlineCode",{parentName:"p"},"eval_body")," we send it to the Ranking Evaluation API using json:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},"eval_body = json.dumps(create_function)\n# our elasticsearch instance is stored in the variable es\nresult = es.rank_eval(eval_body,index_we_want_to_search_on)\n# print the evaluation in readable format\nprint(json.dumps(result, indent=4, sort_keys=True))\n")),(0,i.kt)("details",null,(0,i.kt)("summary",null,'What is "create_function"?'),(0,i.kt)("p",null,"The argument ",(0,i.kt)("inlineCode",{parentName:"p"},"create_function")," is a function we wrote to parse our preprocessed data into the evaluation body format. You can find details in our ",(0,i.kt)("a",{parentName:"p",href:"https://pragmalingu.de/docs/guides/how-to-parse#parse-for-evaluation-body"},"Parsing Guide"),".")),(0,i.kt)("p",null,"It is important to specify which index you would like the Ranking Evaluation API to search, otherwise it will search all available indexes."),(0,i.kt)("p",null,"You can find further information about the Ranking Evaluation API on the ",(0,i.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-rank-eval.html"},"Elasticsearch website"),"."),(0,i.kt)("h3",{id:"2-query-metrics"},"2. Query Metrics"),(0,i.kt)("p",null,"Which query operator you choose to use will depend on the type of data you wish to process.  Below we will provide a brief overview of the three operators we have tested thus far."),(0,i.kt)("h4",{id:"21-match-query-operator"},"2.1. Match Query Operator"),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html"},"Match Query operator")," is the standard search operator in Elasticsearch. It provides a full-text search of the given fields of the document(s) and includes standard tokenization and an analyzer."),(0,i.kt)("p",null,"To use the Match Query operator in the Ranking Evaluation API we first need to add it to every query request in the field ",(0,i.kt)("inlineCode",{parentName:"p"},'"query":')," and also add the query text to the field ",(0,i.kt)("inlineCode",{parentName:"p"},'"text":'),". The operator tries to match the string given in ",(0,i.kt)("inlineCode",{parentName:"p"},'"text":')," with the documents in the given index.\nHere are some example queries:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n    \n  "requests": [\n    {\n      "id": "Query_1",                                  \n      "request": {                                              \n          "query": { "match": { "text": "\\nwhat are the structural and aeroelastic problems associated with flight\\nof high speed aircraft .\\n" } }\n      },\n      "ratings": [                                              \n        ...\n      ]\n    },\n    {\n      "id": "Query_2",\n      "request": {\n        "query": { "match": { "text": "\\nwhat problems of heat conduction in composite slabs have been solved so\\nfar .\\n" } }\n      },\n      "ratings": [\n        ...\n  ]\n  "metric": {\n    ...\n  }\n}\n')),(0,i.kt)("h4",{id:"22-simple-query-string-operator"},"2.2. Simple Query String Operator"),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-simple-query-string-query.html"},"Simple Query String operator ")," uses a parser with a limited error-tolerant syntax to search for the given query string in the given fields. It splits and analyzes the query terms separately for the search before returning the relevant documents. It ignores invalid parts of the query string."),(0,i.kt)("p",null,"Here is an example request with the simple query string operator searching for the query in the 'text' and 'title' fields:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "requests": [\n    {\n      "id": "Query_1",                                  \n      "request": {                                              \n          "query": { "simple_query_string" : {\n               "query": "\\nwhat are the structural and aeroelastic problems associated with flight\\nof high speed aircraft .\\n",\n               "fields": ["title", "text"]\n      }}},\n      "ratings": [                                              \n        ...\n      ]\n    },\n    {\n      "id": "Query_2",\n      "request": {\n        "query": { "simple_query_string" : {\n               "query": "\\nwhat problems of heat conduction in composite slabs have been solved so\\nfar .\\n",\n               "fields": ["title", "text"]\n      }}},\n      "ratings": [\n        ...\n  ]\n  "metric": {\n    ...\n  }\n}\n')),(0,i.kt)("h4",{id:"23-multi-match-query-operator"},"2.3. Multi-Match Query Operator"),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-multi-match-query.html#query-dsl-multi-match-query"},"Multi-Match Query operator")," builds on the match query operator and allows multi-line matches while searching. While it does work similarly to the simple string query it rates the documents a bit differently."),(0,i.kt)("p",null,'If no specific fields are provided it will search all available fields. We chose "title" and "text" since they contain the most information:'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "requests": [\n    {\n      "id": "Query_1",                                  \n      "request": {                                              \n          "query": { "multi_match" : {\n               "query": "\\nwhat are the structural and aeroelastic problems associated with flight\\nof high speed aircraft .\\n",\n               "fields": ["title", "text"]\n      }}},\n      "ratings": [                                              \n        ...\n      ]\n    },\n    {\n      "id": "Query_2",\n      "request": {\n        "query": { "multi_match" : {\n               "query": "\\nwhat problems of heat conduction in composite slabs have been solved so\\nfar .\\n",\n               "fields": ["title", "text"]\n      }}},\n      "ratings": [\n        ...\n  ]\n  "metric": {\n    ...\n  }\n}\n')),(0,i.kt)("p",null,"This was also the operator  we chose for our Standard Search to Stemming Comparison, which you can read in our ",(0,i.kt)("a",{parentName:"p",href:"/docs/experiments/experiment1"},"First Experiment"),"."),(0,i.kt)("h3",{id:"3-rating-metric"},"3. Rating Metric"),(0,i.kt)("p",null,"With our rating metric we are able to rank more relevant documents higher than less relevant ones:for example, if we search for ",(0,i.kt)("inlineCode",{parentName:"p"},"ice cream truck")," we could rate documents with ",(0,i.kt)("inlineCode",{parentName:"p"},"ice cream truck")," higher than documents with ",(0,i.kt)("inlineCode",{parentName:"p"},"ice cream")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"truck")," while still labeling all of those documents as relevant.\nA document\u2019s rating is represented by an integer; the higher the number the more relevant the document. To use this scale in your search you must first adjust the ",(0,i.kt)("inlineCode",{parentName:"p"},"relevant_rating_threshold")," variable to the highest rated number. The default would be 1, which means the different rated documents would all be irrelevant."),(0,i.kt)("p",null,"We can only make this adjustment if we have annotated data that provides the right metrics or if we are willing to rate the relevant documents manually."),(0,i.kt)("p",null,"Therefore, if we do not have any information other than that a document is relevant or irrelevant, we can just use the binary scale; 0 is irrelevant and 1 is relevant."),(0,i.kt)("p",null,"This is an example with higher scaled ratings:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n    \n  "requests": [\n    {\n      "id": "Query_1",                                  \n      "request": {                                              \n          ...\n      },\n      "ratings": [                                              \n        { "_index": "cranfield-corpus", "_id": "184", "rating": 2 },\n        { "_index": "cranfield-corpus", "_id": "29", "rating": 3 },\n        { "_index": "cranfield-corpus", "_id": "31", "rating": 1 }\n      ]\n    },\n    {\n      "id": "Query_2",\n      "request": {\n        ...\n      },\n      "ratings": [\n        { "_index": "cranfield-corpus", "_id": "12", "rating": 1 }\n      ]\n    }\n  ]\n  "metric": {\n    "precision": {\n      "k": 20,\n      "relevant_rating_threshold": 3,\n      "ignore_unlabeled": false\n    }\n  }\n}\n')),(0,i.kt)("p",null,"Since the Cranfield corpus was the only one which provided scaled ratings we only used the binary rating. We also didn't rate any documents with 0, since any unrated document receives a 0 by default."),(0,i.kt)("h3",{id:"4-evaluation-metrics"},"4. Evaluation Metrics"),(0,i.kt)("p",null,"In addition to the metrics we can adjust by changing the request, there are some metrics that influence how the evaluation results will be computed."),(0,i.kt)("h4",{id:"41-precision-at-k"},"4.1. Precision at k"),(0,i.kt)("p",null,"By setting the metric to ",(0,i.kt)("inlineCode",{parentName:"p"},"precision")," and defining ",(0,i.kt)("inlineCode",{parentName:"p"},"k"),", we can measure how many relevant results are returned in the top k results."),(0,i.kt)("p",null,"Since a user typically only looks at the first few results of a search query, it is not necessary to set ",(0,i.kt)("inlineCode",{parentName:"p"},"k")," higher than 20. Reducing the number of top results to 10 or 5 could give an even better idea of the performance."),(0,i.kt)("p",null,"But this metric only recognizes documents as relevant if they are labeled so it is possible that documents that would be relevant, but aren't labeled, would actually worsen the results..\nAlso, the position is not taken in account either. Documents in position 1 and position 10 are considered as equally important."),(0,i.kt)("p",null,"We have already explained the ",(0,i.kt)("inlineCode",{parentName:"p"},"relevant_rating_threshold")," parameter above. With the ",(0,i.kt)("inlineCode",{parentName:"p"},"ignore_unlabeled")," parameter you are able to take the unlabeled documents into account. The default value is ",(0,i.kt)("inlineCode",{parentName:"p"},"false"),", which treats unlabeled documents as irrelevant. But if set to ",(0,i.kt)("inlineCode",{parentName:"p"},"true"),", those documents will not be counted."),(0,i.kt)("p",null,"An example for the Precision metric:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n    \n  "requests": [\n    ...\n  ]\n  "metric": {\n    "precision": {\n      "k": 20,\n      "relevant_rating_threshold": 3,\n      "ignore_unlabeled": false\n    }\n  }\n}\n')),(0,i.kt)("details",null,(0,i.kt)("summary",null,'What is "Precision"?'),(0,i.kt)("p",null,"Precision measures the probability that retrieved documents are relevant to the search query. Therefore the number of all retrieved relevant documents is divided by the number of all retrieved documents. ",(0,i.kt)("br",null),"\nFor example: We retrieve 10 search results and only 5 are relevant for our search.\nThe Precision measure would be: ",(0,i.kt)("inlineCode",{parentName:"p"},"5/10 = 0.5")," ",(0,i.kt)("br",null),"\nTo measure the Precision it is necessary to have the relevant documents labeled as such.\nPrecision only looks at the documents that are retrieved and does not take into account any documents which could have been retrieved.")),(0,i.kt)("h4",{id:"42-recall-at-k"},"4.2. Recall at k"),(0,i.kt)("p",null,"The metric ",(0,i.kt)("inlineCode",{parentName:"p"},"recall")," works very similarly to the ",(0,i.kt)("inlineCode",{parentName:"p"},"precision")," metric. ",(0,i.kt)("inlineCode",{parentName:"p"},"k")," defines how many relevant results are returned in the top k results and taken into account.\nThis metric has its own problems, though, if documents are not labeled.\nThe position is not taken into account either, which can be problematic since the Recall metric does not account for any retrieved irrelevant documents."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"relevant_rating_threshold")," parameter is explained above."),(0,i.kt)("p",null,"An example for the Recall metric:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n    \n  "requests": [\n    ...\n  ]\n  "metric": {\n    "recall": {\n      "k": 20,\n      "relevant_rating_threshold": 3\n    }\n  }\n}\n')),(0,i.kt)("details",null,(0,i.kt)("summary",null,'What is "Recall"?'),(0,i.kt)("p",null,"Recall measures the probability that relevant documents are retrieved.\nTherefore the number of all retrieved relevant documents is divided by the number of all documents that are labeled as relevant. ",(0,i.kt)("br",null),"\nFor example: We search 10 documents, 8 of them are relevant and 4 of the relevant ones are retrieved.\nThe Recall measure would be: ",(0,i.kt)("inlineCode",{parentName:"p"},"4/8 = 0.5")," ",(0,i.kt)("br",null),"\nTo measure the Recall it is necessary to have the relevant documents labeled.\nRecall only looks at the documents that could be retrieved and does not take into account if any irrelevant documents are retrieved aside from the relevant ones.")),(0,i.kt)("br",null),(0,i.kt)("br",null),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Acknowledgements:"),(0,i.kt)("br",null),"\nThanks to Kenny Hall for proofreading this article."),(0,i.kt)("div",{className:"col text--right"},(0,i.kt)("em",null,(0,i.kt)("small",null,"Written by ",(0,i.kt)("strong",null,"Miriam Rupprecht"),",  November 2020"))))}d.isMDXComponent=!0}}]);